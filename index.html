<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Negocios con Ignacio ‚Äì Cat√°logo</title>
  <meta name="description" content="Cat√°logo de motos ‚Äì Negocios con Ignacio. Filtros, cuotas, galer√≠a, WhatsApp y eventos." />
  <link rel="icon" href="/images/logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --gold:#C5A047; --dark:#0B0B0B; }
    body { background: var(--dark); color: #EEE; }
    .gold { color: var(--gold); }
    .btn { border:1px solid rgba(255,255,255,.18); border-radius:14px; padding:10px 14px; display:inline-flex; align-items:center; gap:8px; min-height:44px; }
    .btn:hover { box-shadow:0 8px 28px rgba(0,0,0,.35); }
    .card { background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12); border-radius:18px; }
    .tag { font-size:12px; padding:2px 8px; border-radius:9999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); }
    .input, select { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.28); color:#fff; border-radius:12px; padding:8px 12px; height:40px; }
    select, option { color:#fff; background:#111; }
    ::placeholder { color:#cfcfcf; opacity:.9; }
    .fixed-wa { position:fixed; right:16px; bottom:16px; z-index:50; }
    .grid-auto-fill { display:grid; grid-template-columns: repeat(auto-fill,minmax(270px,1fr)); gap:20px; }
    .iconbtn { border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); height:38px; padding:0 10px; border-radius:10px; display:inline-flex; align-items:center; gap:6px; font-size:13px; }
    a { color: inherit; }
    .chip{display:inline-block;font-size:12px;padding:2px 8px;border-radius:9999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="sticky top-0 z-20 border-b border-white/10 bg-black/70 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center gap-4">
      <img src="/images/logo.png" alt="Negocios con Ignacio" class="h-20 md:h-14 w-auto rounded-lg" onerror="this.src='https://dummyimage.com/200x80/111/ffffff&text=Negocios+con+Ignacio'">
      <span class="uppercase font-extrabold tracking-wide gold text-lg md:text-2xl">NEGOCIOS CON IGNACIO</span>
      <nav class="ml-auto hidden md:flex items-center gap-4 text-sm opacity-90">
        <a href="#catalogo" class="hover:opacity-100">Cat√°logo</a>
        <a href="#agenda" class="hover:opacity-100">Eventos</a>
        <a href="#contacto" class="hover:opacity-100">Contacto</a>
      </nav>
      <a href="#catalogo" class="btn">üîé Buscar</a>
    </div>
  </header>

  <!-- Hero -->
  <section class="mx-auto max-w-7xl px-4 py-10 md:py-14 grid md:grid-cols-2 gap-8 items-center">
    <div>
      <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">
        <span class="gold">Hola</span>, gracias por entrar a mi p√°gina.
      </h1>
      <p class="mt-3 text-zinc-300">
        Ac√° vas a poder ver las motos que vendo, ver los pr√≥ximos eventos y anotarte,
        tambi√©n agendar test drive del modelo que quer√©s y cumplir el sue√±o de tener tu moto.
      </p>
      <div class="mt-5 flex flex-wrap items-center gap-3">
        <a href="#catalogo" class="btn">üõí Ver cat√°logo</a>
        <a href="#agenda" class="btn">üóìÔ∏è Eventos</a>
        <a id="wa-hero" target="_blank" class="btn" style="background: rgba(197,160,71,.18);">üìû WhatsApp</a>
      </div>
    </div>
    <div class="rounded-3xl overflow-hidden aspect-video md:aspect-[4/3] bg-cover bg-center" style="background-image:url('/images/hero.jpg'), linear-gradient(120deg,#111,#222)"></div>
  </section>

  <!-- Cat√°logo -->
  <section id="catalogo" class="mx-auto max-w-7xl px-4 pb-10">
    <div class="flex items-center justify-between gap-3 mb-3">
      <h2 class="text-2xl font-bold gold">Cat√°logo</h2>
      <div id="count" class="text-sm opacity-80"></div>
    </div>

    <div class="card p-4 md:p-5 mb-6">
      <div class="grid grid-cols-2 md:grid-cols-12 gap-3 items-end">
        <label class="text-sm col-span-2 md:col-span-4">B√∫squeda
          <input id="q" placeholder="Modelo, marca, cc‚Ä¶" class="input w-full mt-1" />
        </label>
        <label class="text-sm md:col-span-2">Marca
          <select id="brand" class="w-full mt-1">
            <option value="">Todas</option>
          </select>
        </label>
        <label class="text-sm md:col-span-2">Min
          <input id="minPrice" type="number" class="input w-full mt-1" />
        </label>
        <label class="text-sm md:col-span-2">Max
          <input id="maxPrice" type="number" class="input w-full mt-1" />
        </label>
        <label class="text-sm md:col-span-2">Orden
          <select id="sort" class="w-full mt-1">
            <option value="none">‚Äî</option>
            <option value="price-asc">Precio ‚Üë</option>
            <option value="price-desc">Precio ‚Üì</option>
            <option value="cc-asc">Cilindrada ‚Üë</option>
            <option value="cc-desc">Cilindrada ‚Üì</option>
            <option value="year-desc">A√±o ‚Üì</option>
            <option value="year-asc">A√±o ‚Üë</option>
          </select>
        </label>
        <div class="text-sm md:col-span-2"><button id="clear" class="btn w-full">üßπ Limpiar</button></div>
      </div>

      <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
        <div class="text-sm opacity-80">
          <label>Por p√°gina
            <select id="pageSize" class="input ml-2" style="height:36px;">
              <option>6</option><option selected>10</option><option>12</option><option>16</option>
            </select>
          </label>
        </div>
        <div class="flex items-center gap-2" id="pagerTop"></div>
      </div>
    </div>

    <div id="grid" class="grid-auto-fill"></div>
    <div class="mt-6 flex items-center justify-end gap-2" id="pagerBottom"></div>
  </section>

  <!-- Eventos -->
  <section id="agenda" class="mx-auto max-w-7xl px-4 pb-14">
    <h3 class="text-xl font-bold gold mb-3">Eventos</h3>

    <div id="nextEventHero" class="relative overflow-hidden rounded-2xl border border-white/10" style="min-height:180px;">
      <div class="absolute inset-0 bg-cover bg-center opacity-40" id="nextEventBg"></div>
      <div class="relative z-10 p-4 md:p-6 grid md:grid-cols-3 gap-4 items-center">
        <div class="md:col-span-2">
          <div class="text-xs uppercase tracking-wide opacity-80">Pr√≥ximo evento</div>
          <div class="text-lg md:text-2xl font-semibold" id="heroTitle">‚Äî</div>
          <div class="text-sm opacity-85" id="heroMeta"></div>
          <div class="text-sm opacity-80 mt-1" id="heroDesc"></div>
          <div class="mt-2 flex flex-wrap gap-2">
            <span class="chip" id="heroCapacity" style="display:none;"></span>
            <span class="chip">Solidario</span>
          </div>
        </div>
        <div class="text-center">
          <div class="text-xs opacity-70 mb-1">Comienza en</div>
          <div id="heroCountdown" class="text-2xl font-bold gold tabular-nums">‚Äî</div>
          <div class="mt-3 flex flex-wrap justify-center gap-2">
            <button id="heroWA" class="btn" style="background: rgba(197,160,71,.18);">üì≤ Agendar</button>
            <button id="heroICS" class="btn">‚ûï Calendario</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Contacto -->
  <footer id="contacto" class="border-t border-white/10">
    <div class="mx-auto max-w-7xl px-4 py-8 grid sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <div>
        <div class="font-semibold gold">Negocios con Ignacio</div>
        <div class="text-sm opacity-70 mt-1">M√°s de 2000 clientes. Asesoramiento real.</div>
      </div>
      <div>
        <div class="font-semibold gold">Contacto</div>
        <div class="text-sm opacity-70 mt-1">WhatsApp: 3512004885</div>
        <div class="text-sm opacity-70">C√≥rdoba, Argentina</div>
      </div>
      <div>
        <div class="font-semibold gold">Enlaces</div>
        <div class="flex items-center gap-3 mt-2 opacity-80">
          <a href="https://www.instagram.com" target="_blank" class="underline">Instagram</a>
          <a href="https://www.facebook.com" target="_blank" class="underline">Facebook</a>
        </div>
      </div>
      <div>
        <div class="font-semibold gold">Legales</div>
        <div class="text-xs opacity-70 mt-1">Defensa de las y los consumidores ‚Ä¢ Bot√≥n de arrepentimiento</div>
      </div>
    </div>
    <div class="text-xs opacity-70 text-center pb-8">¬© <span id="year"></span> Negociosconignacio</div>
  </footer>

  <!-- WhatsApp flotante -->
  <a id="wa-float" target="_blank" class="fixed-wa btn" style="background: rgba(197,160,71,.18);">üìû WhatsApp</a>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 z-50 hidden bg-black/70 backdrop-blur">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="relative w-full max-w-4xl card p-3 bg-black">
        <button id="lb-close" class="absolute -top-3 -right-3 btn bg-black">‚úñ</button>
        <img id="lb-main" src="" alt="" class="w-full max-h-[70vh] object-contain rounded-xl">
        <div id="lb-thumbs" class="mt-3 grid grid-cols-6 gap-2"></div>
        <button id="lb-prev" class="absolute left-2 top-1/2 -translate-y-1/2 btn">‚óÄ</button>
        <button id="lb-next" class="absolute right-2 top-1/2 -translate-y-1/2 btn">‚ñ∂</button>
      </div>
    </div>
  </div>

  <!-- Calculadora -->
  <div id="calcbox" class="fixed inset-0 z-50 hidden bg-black/70 backdrop-blur">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="relative w-full max-w-3xl card p-4 md:p-6 bg-black">
        <button id="cb-close" class="absolute -top-3 -right-3 btn bg-black">‚úñ</button>

        <h3 id="cb-title" class="text-xl md:text-2xl font-bold gold">Calculadora de cuotas</h3>
        <div id="cb-price" class="mt-1 text-zinc-300"></div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-5 gap-3">
          <label class="text-sm block">Entrega
            <input id="cb-entrega" type="number" class="input w-full mt-1" value="0" step="10000" min="0">
          </label>
          <label class="text-sm block">Meses
            <input id="cb-meses" type="number" class="input w-full mt-1" value="12" min="1" max="72">
          </label>
          <label class="text-sm block">Tipo de plan
            <select id="cb-plan" class="input w-full mt-1"></select>
          </label>
          <div class="text-sm flex flex-col justify-end">
            <div class="text-xs opacity-70">Cuota estimada</div>
            <div id="cb-cuota" class="text-2xl font-semibold gold">-</div>
          </div>
          <div id="cb-atajos" class="flex items-end gap-2 flex-wrap"></div>
        </div>

        <div class="mt-2 text-xs opacity-70">TNA estimada: <span id="cb-tna-view">-</span></div>
        <div class="mt-3 text-sm opacity-80" id="cb-monto">Monto a financiar: -</div>

        <div class="mt-5 flex flex-col md:flex-row gap-3">
          <a id="cb-wa" target="_blank" class="btn w-full md:w-auto" style="background: rgba(197,160,71,.18);">üìû Enviar por WhatsApp</a>
          <button id="cb-cerrar" class="btn w-full md:w-auto">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Test Drive -->
  <div id="tdbox" class="fixed inset-0 z-50 hidden bg-black/70 backdrop-blur">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="relative w-full max-w-2xl card p-4 md:p-6 bg-black">
        <button id="td-close" class="absolute -top-3 -right-3 btn bg-black">‚úñ</button>
        <h3 class="text-xl md:text-2xl font-bold gold">Agendar Test Drive</h3>
        <div id="td-model-view" class="mt-1 text-zinc-300"></div>

        <div class="mt-4 rounded-xl border border-red-500/40 bg-red-500/10 p-3">
          <div class="font-semibold text-red-400">‚ö† IMPORTANTE</div>
          <div class="text-sm mt-1">
            Tu turno es <span class="gold font-semibold">exclusivo</span> y la moto quedar√° reservada para tu prueba.
            Si no pod√©s asistir, <span class="gold font-semibold">avis√° con 24 hs de anticipaci√≥n</span> para liberar el lugar.
            As√≠ aseguramos que todos puedan vivir la experiencia.
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="text-sm block">Fecha y hora
            <input id="td-dt" type="datetime-local" class="input w-full mt-1">
          </label>
          <label class="text-sm block">Nombre
            <input id="td-name" class="input w-full mt-1" placeholder="Tu nombre">
          </label>
          <label class="text-sm block">Tel√©fono
            <input id="td-phone" class="input w-full mt-1" placeholder="Tu tel√©fono">
          </label>
          <label class="text-sm block">Notas
            <input id="td-notes" class="input w-full mt-1" placeholder="Ej: tengo casco propio">
          </label>
        </div>

        <div class="mt-5 flex flex-wrap gap-2">
          <a id="td-wa" target="_blank" class="btn" style="background: rgba(197,160,71,.18);">üì≤ Confirmar por WhatsApp</a>
          <button id="td-ics" class="btn">‚ûï Agregar a mi calendario (.ics)</button>
          <button id="td-cerrar" class="btn">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG FINANCIACI√ìN ======
    const RULE_SMALL_CC = (cc)=> cc!=null && cc < 249;
    const DEFAULT_PLANS  = ["FIJA","UVA"];
    const DEFAULT_TNA    = { FIJA:54, UVA:20 };
    const DEFAULT_MONTHS = [12,18,24,36,48];

    // ====== STATE ======
    let PRODUCTS = [];
    let STATE = { q:"", brand:"", minPrice:0, maxPrice:0, sort:"none", page:1, pageSize:10 };

    // ====== UTIL ======
    const currency = n => new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}).format(n);
    const waBase = "https://wa.me/543512004885";
    const waDefault = "Hola Nacho, quiero info y *Opciones disponibles*";
    const $ = s => document.querySelector(s);
    const pad = n => String(n).padStart(2,"0");
    function toICSDate(dt){ const d=new Date(dt); const y=d.getFullYear(),m=pad(d.getMonth()+1),da=pad(d.getDate()),h=pad(d.getHours()),mi=pad(d.getMinutes()); return `${y}${m}${da}T${h}${mi}00`; }
    function downloadICS({title, desc, start, end, location, filename}){
      const ics = [
        "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Negocios con Ignacio//Agenda//ES",
        "BEGIN:VEVENT",
        "UID:"+ (crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"@negociosconignacio")),
        "DTSTAMP:"+toICSDate(new Date()),
        "DTSTART:"+toICSDate(start),
        "DTEND:"+toICSDate(end),
        "SUMMARY:"+title,
        "DESCRIPTION:"+String(desc||"").replace(/\n/g,"\\n"),
        "LOCATION:"+String(location||"C√≥rdoba"),
        "END:VEVENT","END:VCALENDAR"
      ].join("\r\n");
      const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = (filename||"evento") + ".ics"; document.body.appendChild(a); a.click(); a.remove();
    }

    // ====== TARJETAS ======
    function priceView(p){ return (p.price && p.price > 0) ? currency(p.price) : (p.priceLabel || "Consultar precio"); }
    function makeCard(p){
      const card = document.createElement("div");
      card.className = "card overflow-hidden";
      card.id = p.id;
      card.innerHTML = `
        <div class="aspect-video bg-cover bg-center" style="background-image:url('${p.cover}'), linear-gradient(120deg,#111,#222)"></div>
        <div class="p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-semibold leading-tight">${p.title}</h3>
              <div class="mt-1 text-xs opacity-70">${p.brand} ${p.year>0 ? "‚Ä¢ "+p.year : ""} ${p.km ? "‚Ä¢ "+p.km.toLocaleString("es-AR")+" km" : ""}</div>
            </div>
            <div class="flex gap-2">
              <button class="iconbtn btn-share" title="Compartir">‚Üó</button>
            </div>
          </div>
          <div class="mt-1 text-xl font-bold gold">${priceView(p)}</div>
          <div class="mt-2 flex flex-wrap gap-2">${(p.tags||[]).map(t=>'<span class="tag">'+t+'</span>').join('')}</div>

          <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-2">
            <a href="#" class="btn w-full btn-open-calc"${(p.price||0)<=0?' style="opacity:.6;pointer-events:none"':''}>üßÆ Cuotas</a>
            <a target="_blank" href="${waBase}?text=${encodeURIComponent('Hola Nacho, me interesa *'+p.title+'*. ¬øOpciones disponibles?')}" class="btn w-full" style="background: rgba(197,160,71,.18);">üìû WhatsApp</a>
            <a href="#" class="btn w-full md:col-span-1 col-span-2 btn-gallery">üñºÔ∏è Ver fotos</a>
            <a href="#" class="btn w-full md:col-span-1 col-span-2 btn-testdrive">üöó Test drive</a>
          </div>
        </div>`;
      card.querySelector(".btn-gallery").addEventListener("click",(e)=>{ e.preventDefault(); openGallery(p); });
      if ((p.price||0)>0) card.querySelector(".btn-open-calc").addEventListener("click",(e)=>{ e.preventDefault(); openCalc(p); });
      card.querySelector(".btn-share").addEventListener("click", ()=>{
        const url = location.origin + location.pathname + "#"+p.id;
        const text = `Mir√° esta moto: ${p.title} ‚Äì ${priceView(p)}\n${url}\n¬øLa vemos?`;
        if (navigator.share) { navigator.share({ title: p.title, text, url }).catch(()=>{}); }
        else { window.open(`https://wa.me/543512004885?text=${encodeURIComponent(text)}`,"_blank"); }
      });
      card.querySelector(".btn-testdrive").addEventListener("click",(e)=>{ e.preventDefault(); openTestDrive(p); });
      return card;
    }

    function renderGrid(paged){
      const grid = $("#grid");
      grid.innerHTML = "";
      paged.items.forEach(p=> grid.appendChild(makeCard(p)));
      document.getElementById("count").textContent = `${paged.total} resultados ¬∑ p√°gina ${paged.page} de ${paged.pages}`;
    }

    // ====== LIGHTBOX ======
    let LB = { list:[], idx:0 };
    function openGallery(p){ LB.list = (p.gallery && p.gallery.length ? p.gallery : [p.cover]); LB.idx = 0; renderLB(); document.getElementById("lightbox").classList.remove("hidden"); }
    function renderLB(){
      const main = document.getElementById("lb-main");
      const thumbs = document.getElementById("lb-thumbs");
      main.src = LB.list[LB.idx];
      thumbs.innerHTML = "";
      LB.list.forEach((src,i)=>{
        const t = document.createElement("img");
        t.src = src;
        t.className = "h-16 w-full object-cover rounded-md border " + (i===LB.idx ? "border-[var(--gold)]" : "border-white/10");
        t.addEventListener("click", ()=>{ LB.idx=i; renderLB(); });
        thumbs.appendChild(t);
      });
    }
    document.getElementById("lb-close").onclick = ()=> document.getElementById("lightbox").classList.add("hidden");
    document.getElementById("lb-next").onclick = ()=>{ LB.idx=(LB.idx+1)%LB.list.length; renderLB(); };
    document.getElementById("lb-prev").onclick = ()=>{ LB.idx=(LB.idx-1+LB.list.length)%LB.list.length; renderLB(); };
    document.getElementById("lightbox").addEventListener("click",(e)=>{ if(e.target.id==="lightbox") document.getElementById("lightbox").classList.add("hidden"); });

    // ====== FINANCIACI√ìN ======
    function getFinanceFor(p){ return (RULE_SMALL_CC(p.cc)) ? { plans:["FIJA"], tna:{FIJA:89}, months: DEFAULT_MONTHS, defaultPlan:"FIJA" } : { plans: DEFAULT_PLANS, tna: DEFAULT_TNA, months: DEFAULT_MONTHS, defaultPlan:"FIJA" }; }
    let CALC_PRODUCT = null;
    function frenchInstallment(amount, months, tna){ const i=(tna/12)/100; if(months<=0||amount<=0) return 0; if(i===0) return amount/months; const f=Math.pow(1+i,months); return amount*((i*f)/(f-1)); }
    function openCalc(p){
      CALC_PRODUCT = p;
      const f = getFinanceFor(p);
      document.getElementById("cb-title").textContent = "Calculadora de cuotas ‚Äì " + p.title;
      document.getElementById("cb-price").textContent = "Precio: " + currency(p.price);
      document.getElementById("cb-entrega").value = 0;
      document.getElementById("cb-meses").value = f.months[0] || 12;
      const planSel = document.getElementById("cb-plan");
      planSel.innerHTML = "";
      f.plans.forEach(pl=>{ const opt=document.createElement("option"); opt.value=pl; opt.textContent=pl; planSel.appendChild(opt); });
      planSel.value = f.defaultPlan || f.plans[0];
      const atajos = document.getElementById("cb-atajos");
      atajos.innerHTML="";
      f.months.forEach(m=>{ const b=document.createElement("button"); b.className="btn cb-atajo"; b.dataset.meses=m; b.textContent=m; b.addEventListener("click", ()=>{ document.getElementById("cb-meses").value=m; updateCalc(); }); atajos.appendChild(b); });
      updateCalc(); document.getElementById("calcbox").classList.remove("hidden");
    }
    function closeCalc(){ document.getElementById("calcbox").classList.add("hidden"); }
    function updateCalc(){
      if(!CALC_PRODUCT) return;
      const f = getFinanceFor(CALC_PRODUCT);
      const entrega = Math.max(parseFloat(document.getElementById("cb-entrega").value||"0"),0);
      const months  = Math.max(parseInt(document.getElementById("cb-meses").value||String(f.months[0]||12)),1);
      const plan    = document.getElementById("cb-plan").value || f.defaultPlan;
      const rate    = (f.tna && f.tna[plan] != null) ? f.tna[plan] : 54;
      document.getElementById("cb-tna-view").textContent = rate + "%";
      const monto   = Math.max(CALC_PRODUCT.price - entrega, 0);
      const cuota   = Math.round(frenchInstallment(monto, months, rate));
      document.getElementById("cb-cuota").textContent = currency(cuota);
      document.getElementById("cb-monto").textContent = "Monto a financiar: " + currency(monto);
      const msg = [
        "Hola Nacho, me interesa *"+CALC_PRODUCT.title+"*.",
        "", "Opciones calculadas:",
        "‚Ä¢ Precio: "+currency(CALC_PRODUCT.price),
        "‚Ä¢ Entrega: "+currency(entrega),
        "‚Ä¢ A financiar: "+currency(monto),
        "‚Ä¢ Plan: "+months+" cuotas ("+plan+", TNA "+rate+"% aprox.)",
        "‚Ä¢ Estimaci√≥n de cuota: "+currency(cuota), "", "¬øLa podemos ver?"
      ].join("\n");
      document.getElementById("cb-wa").href = "https://wa.me/543512004885?text=" + encodeURIComponent(msg);
    }
    document.getElementById("cb-close").onclick  = closeCalc;
    document.getElementById("cb-cerrar").onclick = closeCalc;
    document.getElementById("calcbox").addEventListener("click",(e)=>{ if(e.target.id==="calcbox") closeCalc(); });
    ["cb-entrega","cb-meses","cb-plan"].forEach(id=>{ document.getElementById(id).addEventListener("input", updateCalc); document.getElementById(id).addEventListener("change", updateCalc); });

    // ====== FILTROS + PAGER ======
    function populateBrands(){
      const sel = document.getElementById("brand");
      const brands = Array.from(new Set(PRODUCTS.map(p=>p.brand).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      brands.forEach(b=>{ const o=document.createElement("option"); o.value=b; o.textContent=b; sel.appendChild(o); });
    }

    function applyFilters(){
      STATE.q        = document.getElementById("q").value.toLowerCase();
      STATE.brand    = document.getElementById("brand").value;
      STATE.minPrice = parseFloat(document.getElementById("minPrice").value || "0");
      STATE.maxPrice = parseFloat(document.getElementById("maxPrice").value || "0");
      STATE.sort     = document.getElementById("sort").value;
      STATE.pageSize = parseInt(document.getElementById("pageSize").value || "10",10);

      let list = PRODUCTS.filter(p=>{
        const s = [p.title, p.brand, String(p.cc||""), String(p.year||"")].join(" ").toLowerCase();
        const okQ = STATE.q ? s.includes(STATE.q) : true;
        const okB = STATE.brand ? p.brand === STATE.brand : true;
        const okMin = STATE.minPrice ? (p.price||0) >= STATE.minPrice : true;
        const okMax = STATE.maxPrice ? (p.price||0) <= STATE.maxPrice : true;
        return okQ && okB && okMin && okMax;
      });

      const keyers = { "price": p=> p.price||0, "cc": p=> p.cc||0, "year": p=> p.year||0 };
      if(STATE.sort !== "none"){
        const [k,dir] = STATE.sort.split("-");
        const key = keyers[k] || (()=>0);
        list = list.slice().sort((a,b)=> (key(a)-key(b)) * (dir==="asc"?1:-1));
      }

      const total = list.length;
      const pages = Math.max(1, Math.ceil(total / STATE.pageSize));
      if (STATE.page > pages) STATE.page = pages;
      const start = (STATE.page-1) * STATE.pageSize;
      const items = list.slice(start, start + STATE.pageSize);

      renderGrid({items, total, page:STATE.page, pages});
      renderPager({total, page:STATE.page, pages});
    }

    function renderPager({total, page, pages}){
      const mk = (where)=>{
        const host = document.getElementById(where);
        host.innerHTML = "";
        const prev = document.createElement("button");
        prev.className = "iconbtn"; prev.textContent = "‚óÄ Anterior";
        prev.disabled = page<=1; prev.onclick = ()=>{ STATE.page=Math.max(1,STATE.page-1); applyFilters(); };
        const next = document.createElement("button");
        next.className = "iconbtn"; next.textContent = "Siguiente ‚ñ∂";
        next.disabled = page>=pages; next.onclick = ()=>{ STATE.page=Math.min(pages,STATE.page+1); applyFilters(); };
        const label = document.createElement("div");
        label.className = "text-sm opacity-80"; label.textContent = `P√°gina ${page} de ${pages}`;
        host.appendChild(prev); host.appendChild(label); host.appendChild(next);
      };
      mk("pagerTop"); mk("pagerBottom");
    }

    // ====== EVENTOS (hero) ======
    const EVENTS = [
      { id:"dia-nino-kempes-2025", title:"D√≠a del Ni√±o ‚Äì Parque del Kempes", when:"2025-08-18T15:00",
        durationMin:180, place:"Parque del Kempes, C√≥rdoba",
        description:"Festejo del D√≠a del Ni√±o y convocatoria solidaria para ayudar a los necesitados.",
        capacity:200, cover:"/images/events/kempes.jpg" }
    ];
    function setupHero(nextEv){
      const wrapBg = document.getElementById("nextEventBg");
      const title = document.getElementById("heroTitle");
      const meta  = document.getElementById("heroMeta");
      const desc  = document.getElementById("heroDesc");
      const cap   = document.getElementById("heroCapacity");
      const cd    = document.getElementById("heroCountdown");
      const btnWA = document.getElementById("heroWA");
      const btnICS= document.getElementById("heroICS");

      if(!nextEv){ title.textContent="Sin eventos pr√≥ximos"; meta.textContent=""; desc.textContent=""; cd.textContent="‚Äî"; return; }
      wrapBg.style.backgroundImage = nextEv.cover ? `url('${nextEv.cover}')` : "linear-gradient(120deg,#111,#222)";
      title.textContent = nextEv.title;
      meta.textContent  = `${nextEv._start.toLocaleDateString("es-AR",{weekday:"long", day:"2-digit", month:"long"})} ‚Ä¢ ${nextEv._start.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"})} hs ‚Ä¢ ${nextEv.place||"C√≥rdoba"}`;
      desc.textContent  = nextEv.description || "";
      if(nextEv.capacity){ cap.style.display="inline-block"; cap.textContent = `Cupo: ${nextEv.capacity}`; } else { cap.style.display="none"; }

      btnWA.onclick = ()=>{
        const msg = `Hola Nacho, quiero *anotarme*:
‚Ä¢ ${nextEv.title}
‚Ä¢ ${nextEv._start.toLocaleString("es-AR")}
‚Ä¢ Lugar: ${nextEv.place||"C√≥rdoba"}`;
        window.open(`${waBase}?text=${encodeURIComponent(msg)}`,"_blank");
      };
      btnICS.onclick = ()=>{
        const end = new Date(nextEv._start.getTime() + (nextEv.durationMin||60)*60000);
        downloadICS({ title: nextEv.title, desc: nextEv.description||"", start: nextEv._start, end, location: nextEv.place||"C√≥rdoba", filename: nextEv.id||"evento" });
      };

      function pad2(n){ return String(n).padStart(2,"0"); }
      let timer = setInterval(()=>{
        const now = Date.now(), tgt = nextEv._start.getTime(), diff = tgt - now;
        if(diff<=0){ cd.textContent="¬°Es ahora!"; clearInterval(timer); return; }
        const d=Math.floor(diff/86400000), h=Math.floor((diff%86400000)/3600000), m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000);
        cd.textContent = `${pad2(d)}d ${pad2(h)}h ${pad2(m)}m ${pad2(s)}s`;
      },1000);
    }
    function initEventsUI(){ const ev = {...EVENTS[0], _start: new Date(EVENTS[0].when)}; setupHero(ev); }

    // ====== CARGA DE DATOS ======
    async function loadProducts(){
      try{
        const res = await fetch("/data/products.json", { cache: "no-store" });
        if(!res.ok) throw new Error("No se pudo cargar /data/products.json");
        PRODUCTS = await res.json();

        // Asegurar campos m√≠nimos para que no rompa
        PRODUCTS = (PRODUCTS||[]).map(p=>{
          p.gallery = Array.isArray(p.gallery) && p.gallery.length ? p.gallery : [p.cover || `https://dummyimage.com/1200x800/111/ffffff&text=${encodeURIComponent(p.title||'MOTO')}`];
          p.cover = p.gallery[0];
          return p;
        });

        populateBrands();
        applyFilters();
      }catch(err){
        console.error(err);
        const grid = document.getElementById("grid");
        grid.innerHTML = `<div class="card p-4">No se pudo cargar <code>/data/products.json</code>. Verific√° la ruta y prob√° refrescar.</div>`;
      }
    }

    // ====== INIT ======
    document.getElementById("year").textContent = new Date().getFullYear();
    document.getElementById("wa-hero").href  = `${waBase}?text=${encodeURIComponent(waDefault)}`;
    document.getElementById("wa-float").href = `${waBase}?text=${encodeURIComponent(waDefault)}`;

    ["q","brand","minPrice","maxPrice","sort","pageSize"].forEach(id=>{
      document.getElementById(id).addEventListener("input", ()=>{ STATE.page=1; applyFilters(); });
      document.getElementById(id).addEventListener("change", ()=>{ STATE.page=1; applyFilters(); });
    });
    document.getElementById("clear").addEventListener("click", ()=>{
      ["q","brand","minPrice","maxPrice"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("sort").value="none";
      STATE.page=1;
      applyFilters();
    });

    initEventsUI();
    loadProducts(); // <‚Äî Carga JSON externo
  </script>
</body>
  </html>
